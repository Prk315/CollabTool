<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  {% extends "base.html" %}

  {% block title %}Calendar - User {{ user_id }}{% endblock %}

  {% block head %}
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  {% endblock %}
</head>
<body>
  {% block content %}
  <div class="mb-6">
      <h1>User {{ user_id }} Calendar</h1>
      <p class="text-muted">Manage your availability, view busy times, and track project deadlines</p>
  </div>

  <div class="card">
      <div class="card-content">
          <div id="calendar"></div>
      </div>
  </div>
  {% endblock %}

  {% block scripts %}
  <script>
  document.addEventListener('DOMContentLoaded', async () => {
      const uid = {{ user_id }};
      const feed = await fetch(`/calendar/api/${uid}`).then(r => r.json());

      const cal = new FullCalendar.Calendar(
          document.getElementById('calendar'),
          {
              initialView: 'dayGridMonth',
              selectable: true,
              editable: true,
              headerToolbar: {
                  left: 'prev,next today',
                  center: 'title',
                  right: 'dayGridMonth,timeGridWeek,listWeek'
              },
              events: feed.map(ev => ({
                  id: ev.id || null,
                  title: ev.type === 'Available' ? 'Available'
                      : ev.type === 'Busy' ? `Busy: ${ev.description || ''}`
                      : ev.type === 'Session' ? `Session: ${ev.description || ''}`
                      : `Project: ${ev.description || ''}`,
                  start: ev.start,
                  end: ev.end,
                  color: ev.type === 'Busy' ? 'red'
                      : ev.type === 'Available' ? 'green'
                      : ev.type === 'Session' ? 'purple'
                      : 'blue'
              })),

              select: async info => {
                  if (!confirm(`Add availability:\n${info.startStr} â†’ ${info.endStr}?`)) {
                      cal.unselect();
                      return;
                  }
                  const res = await fetch('/availability/api', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ user_id: uid, start: info.startStr, end: info.endStr })
                  }).then(r => r.json());

                  cal.addEvent({
                      id: res.id, title: 'Available',
                      start: info.start, end: info.end, color: 'green'
                  });
              },

              eventDrop: handleUpdate,
              eventResize: handleUpdate,

              eventClick: async info => {
                  if (info.event.title !== 'Available') return;
                  if (!confirm('Delete this availability?')) return;
                  await fetch(`/availability/api/${info.event.id}`, { method: 'DELETE' });
                  info.event.remove();
              }
          });

      async function handleUpdate(info) {
          if (info.event.title !== 'Available') {
              info.revert();
              return;
          }
          await fetch(`/availability/api/${info.event.id}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                  start: info.event.start.toISOString(),
                  end: info.event.end.toISOString()
              })
          });
      }

      cal.render();
  });
  </script>
  {% endblock %}
</body>
</html>
